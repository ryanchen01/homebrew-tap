name: Update Formula

on:
  workflow_dispatch:
    inputs:
      formula:
        description: 'Formula name (e.g., mcd-cn)'
        required: true
        type: string
      tag:
        description: 'Release tag to update formula for'
        required: true
        type: string
      repository:
        description: 'Source repository (e.g., ryanchen01/mcd-cn)'
        required: true
        type: string

jobs:
  update-formula:
    runs-on: macos-latest
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Update formula
        run: |
          set -euo pipefail
          FORMULA="${{ github.event.inputs.formula }}"
          TAG="${{ github.event.inputs.tag }}"
          REPO="${{ github.event.inputs.repository }}"
          VERSION="${TAG#v}"
          
          # Download the release artifacts for macOS and Linux (matches mcd-cn.rb naming).
          for ARCH in darwin_amd64 darwin_arm64 linux_amd64 linux_arm64; do
            FILENAME="${FORMULA}_${VERSION}_${ARCH}.tar.gz"
            DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${TAG}/${FILENAME}"
            curl -L "${DOWNLOAD_URL}" -o "${FILENAME}"
            SHA256=$(shasum -a 256 "${FILENAME}" | awk '{print $1}')
            case "${ARCH}" in
              darwin_amd64)
                URL_DARWIN_AMD64="${DOWNLOAD_URL}"
                SHA_DARWIN_AMD64="${SHA256}"
                ;;
              darwin_arm64)
                URL_DARWIN_ARM64="${DOWNLOAD_URL}"
                SHA_DARWIN_ARM64="${SHA256}"
                ;;
              linux_amd64)
                URL_LINUX_AMD64="${DOWNLOAD_URL}"
                SHA_LINUX_AMD64="${SHA256}"
                ;;
              linux_arm64)
                URL_LINUX_ARM64="${DOWNLOAD_URL}"
                SHA_LINUX_ARM64="${SHA256}"
                ;;
            esac
          done

          export FORMULA VERSION
          export URL_DARWIN_AMD64 SHA_DARWIN_AMD64
          export URL_DARWIN_ARM64 SHA_DARWIN_ARM64
          export URL_LINUX_AMD64 SHA_LINUX_AMD64
          export URL_LINUX_ARM64 SHA_LINUX_ARM64

          ruby <<'RUBY'
          file = File.join("Formula", "#{ENV.fetch("FORMULA")}.rb")
          version = ENV.fetch("VERSION")
          mapping = {
            "darwin_amd64" => [ENV.fetch("URL_DARWIN_AMD64"), ENV.fetch("SHA_DARWIN_AMD64")],
            "darwin_arm64" => [ENV.fetch("URL_DARWIN_ARM64"), ENV.fetch("SHA_DARWIN_ARM64")],
            "linux_amd64" => [ENV.fetch("URL_LINUX_AMD64"), ENV.fetch("SHA_LINUX_AMD64")],
            "linux_arm64" => [ENV.fetch("URL_LINUX_ARM64"), ENV.fetch("SHA_LINUX_ARM64")]
          }

          lines = File.readlines(file)
          current_arch = nil
          lines.map! do |line|
            if line =~ /version ".*"/
              line = line.sub(/version ".*"/, "version \"#{version}\"")
            end

            if line =~ /url ".*(darwin_amd64|darwin_arm64|linux_amd64|linux_arm64).*"/
              arch = Regexp.last_match(1)
              current_arch = arch
              line = line.sub(/url ".*"/, "url \"#{mapping.fetch(arch).first}\"")
            elsif current_arch && line =~ /sha256 ".*"/
              line = line.sub(/sha256 ".*"/, "sha256 \"#{mapping.fetch(current_arch).last}\"")
              current_arch = nil
            end
            line
          end

          File.write(file, lines.join)
          RUBY
          
          # Commit and push
          git add "Formula/${FORMULA}.rb"
          git commit -m "Update ${FORMULA} to ${TAG}"
          git push
